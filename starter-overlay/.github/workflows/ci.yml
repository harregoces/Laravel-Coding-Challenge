name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: sqlite, pdo_sqlite, mbstring, tokenizer, xml, curl, fileinfo, dom, openssl
          coverage: none

      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Bootstrap Laravel 12 + Sanctum + Larastan
        run: |
          chmod +x scripts/bootstrap-laravel.sh
          ./scripts/bootstrap-laravel.sh

      - name: Configure app key and DB
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan migrate:fresh --seed

      - name: Run tests
        run: php artisan test --colors=always

      - name: Run Larastan (level 7)
        run: vendor/bin/phpstan analyse --error-format=github

  build:
    needs: test
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
      PUBLISH: ${{ vars.PUBLISH || 'false' }}
      MAKE_PUBLIC: ${{ vars.MAKE_PUBLIC || 'false' }}
    steps:
      - uses: actions/checkout@v4

      - name: Bootstrap Laravel 12 (for build)
        run: |
          chmod +x scripts/bootstrap-laravel.sh
          ./scripts/bootstrap-laravel.sh

      - name: Log in to GHCR
        if: env.PUBLISH == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build (Apache image)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: starter-overlay/Containerfile
          push: ${{ env.PUBLISH == 'true' }}
          tags: ${{ env.IMAGE_NAME }}

      - name: Make GHCR image public (optional)
        if: env.PUBLISH == 'true' && env.MAKE_PUBLIC == 'true'
        env:
          PKG_NAME: ${{ github.event.repository.name }}
        run: |
          echo "Attempting to set GHCR package visibility to public..."
          curl -L -X PATCH             -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"             -H "Accept: application/vnd.github+json"             https://api.github.com/user/packages/container/${PKG_NAME}/visibility             -d '{"visibility":"public"}' || true
